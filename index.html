<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>XPAIO - Pi Payment Test</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
        body { background-color: #0d1117; color: #fff; font-family: sans-serif; text-align: center; padding-top: 50px; }
        .pay-btn { background-color: #6200ee; color: white; border: none; padding: 20px 40px; border-radius: 12px; font-weight: bold; font-size: 1.5em; cursor: pointer; margin-top: 30px; }
        #status { color: #58a6ff; margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>XPAIO 결제 시스템</h1>
    <div id="status">파이 네트워크와 연결 중...</div>
    
    <button id="pay-button" class="pay-btn" onclick="startPayment()" style="display:none;">
        테스트 결제 시도 (0.1 Pi)
    </button>

    <script>
        const Pi = window.Pi;

        async function initPi() {
            try {
                // 샌드박스 모드를 통해 실전 도메인 인증을 시도합니다
                await Pi.init({ version: "2.0", sandbox: true });
                const auth = await Pi.authenticate(['payments', 'username'], (payment) => {
                    console.log("미완료 결제 발견:", payment);
                });
                
                document.getElementById("status").innerText = auth.user.username + " 리더님, 연결되었습니다!";
                document.getElementById("pay-button").style.display = "inline-block";
            } catch (err) {
                // 만약 여기서 코드가 나오면 포털에 입력하고, 안 나오면 바로 결제 시도가 가능합니다
                document.getElementById("status").innerText = "인증 대기 중: " + err.message;
            }
        }

        async function startPayment() {
            try {
                await Pi.createPayment({
                    amount: 0.1,
                    memo: "XPAIO 10단계 최종 검증",
                    metadata: { orderId: "XPAIO_FINAL_01" },
                }, {
                    onReadyForServerApproval: async (paymentId) => {
                        // 서버가 없으므로 자체적으로 승인 신호(true)를 보냅니다
                        console.log("결제 승인 단계:", paymentId);
                        return true; 
                    },
                    onReadyForServerCompletion: async (paymentId, txid) => {
                        // 결제가 블록체인에 기록되면 성공 알림을 띄웁니다
                        alert("결제 성공! txid: " + txid);
                    },
                    onCancel: () => alert("결제를 취소하셨습니다."),
                    onError: (err) => alert("결제 에러: " + err.message)
                });
            } catch (err) {
                console.error(err);
            }
        }
        window.onload = initPi;
    </script>
</body>
</html>